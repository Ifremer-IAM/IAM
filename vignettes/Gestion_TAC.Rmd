---
title: "Gestion avec TAC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Gestion avec TAC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
# bibliography: vignette.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Le modèle bio-économique IAM a été développé dans l'optique d'être utilisé pour des scénarios de gestion de quotas. Ainsi, des scénarios de Gestion par TAC peuvent être introduit à différentes échelles. Ce document traite de la gestion de TAC à un niveau interflotilles puis une autre partie détaillera la gestion intra flotilles.

L'ensemble de ces simulations sera réalisé avec le jeu de donnée example `Ifremer` composé de 7 flotilles et deux 3 espèces dynamiques dont une espèce à dynamique SS3.

```{r inport}
library(IAM)
load(IAM_example("IAM_SS3_1984.RData"))

IAM_input_1984 <- IAM::IAM.input(
  fileIN = IAM_example("inputFile.xlsx"),
  t_init = 1984, nbStep = 12, folderFleet = IAM_example("fleets"),
  Fq_i = list(DAR = iniFq_i), iniFq_i = list(DAR = iniFq_i),
  Fq_fmi = list(DAR = iniFq_fmi), iniFq_fmi = list(DAR = iniFq_fmi),
  FqLwt_i = list(DAR = iniFqLwt_i), iniFqLwt_i = list(DAR = iniFqLwt_i),
  FqLwt_fmi = list(DAR = iniFqLwt_fmi), iniFqLwt_fmi = list(DAR = iniFqLwt_fmi),
  FqDwt_i = list(DAR = iniFqDwt_i), iniFqDwt_i = list(DAR = iniFqDwt_i),
  FqDwt_fmi = list(DAR = iniFqDwt_fmi), iniFqDwt_fmi = list(DAR = iniFqDwt_fmi),
  Nt0s1q = list(DAR = Nt0s1q), Ni0q = list(DAR = Ni0q),
  iniNt0q = list(DAR = iniNt0q), matwt = list(DAR = mat_morphage)
)
summary(IAM_input_1984)
```


```{r falseinport, include=FALSE, eval=FALSE}
data("IAM_input_1984")
summary(IAM_input_1984)
```

L'objet argument est laissé tel quel lors de l'utilisation de l'interface et sera édité à la main plus tard pour chaque scénario.

```{r argum, eval=FALSE}
IAM_argum_1984 <- IAM.args(IAM_input_1984)
```

Cela revient à initialiser un objet de classe `iamArgs` sans passer par l'interface avec la commande suivante :

```{r init_argum}
IAM_argum_1984 <- IAM.input2args(IAM_input_1984)
```

```{r falseargum, include=FALSE, eval=FALSE}
data("IAM_argum_1984")
```

## Besoin d'un scénario *statu quo*

Afin de pouvoir comparer l'effet de chaque scénario, il nous faut un scénario de départ dans lequel aucune mesure de Gestion s'imposera.

Dans un premier temps il est utile de définir les dynamiques de recrutements ainsi que des éléments de paramétrage du module économique. On va pour cela éditer l'objet `IAM_argum_1984`.

```{r edit argum}
# Module SR
# On ne modifie pas les recrutements
# TODO add boken stick Rec..where is the value ?

# Module EcoDCF
IAM_argum_1984 <- IAM.editArgs_Eco(IAM_argum_1984, dr = 0.04, perscCalc = 1)

# Module Gestion
mfm <- with(IAM_input_1984@input$Fleet,{
  (effort1_f_m * effort2_f_m * nbv_f_m) / as.vector(effort1_f * effort2_f * nbv_f)
})
mfm[is.na(mfm)] <- 0

IAM_argum_1984 <- IAM.editArgs_Gest(IAM_argum_1984, active = FALSE, 
                                    delay = 1, mfm = mfm)

# Module Scenario
IAM_argum_1984 <- IAM.editArgs_Scenar(IAM_argum_1984) # desactivate scenario

summary(IAM_argum_1984)
```


```{r statuquo}
sim_statu_quo <- IAM::IAM.model(objArgs = IAM_argum_1984, objInput = IAM_input_1984)
```


## Gestion TAC générale

Les différentes options de réglages du module Gestion sont exposées dans la vignette "Utilisation IAM dans R". Il s'agit ici de les explorer plus en avant et de les utiliser.

On fixe ici un scénario de Gestion qui va agir sur le nombre de navire afin d'atteindre un TAC (*Total allowable catches*) donné pour chaque année. Ce quotas vise particulièrement l'espèce dite "COR" et rentre en application 2 ans après le début de la simulation, soit en 1986. Les modification d'efforts seront multiplicatives.

```{r editargum}
IAM_argum_1984_TAC <- IAM.editArgs_Gest(
  IAM_argum_1984, active = TRUE, control = "Nb vessels", target = "TAC",
  espece = "COR", delay = 2, type = "x", bounds = c(100, -100), # X2 a -100 entraine des flottes a 0 navires !
  tac = c(NA, NA, rep(3200, 10)))
      #   84, 85, 1986:1995
```

Cette simulation permet de diminuer drastiquement la mortalite par pêche de l'espèce dite "COR" avec une reduction immédiate la taille des flottilles. 

```{r TAC}
sim_TACglob <- IAM::IAM.model(objArgs = IAM_argum_1984_TAC, objInput = IAM_input_1984)

sim_TACglob@outputSp$Fbar$COR
sim_TACglob@outputSp$SSB$COR
sim_TACglob@outputSp$L_et$COR
sim_TACglob@outputSp$L_et$COR / IAM_argum_1984_TAC@arguments$Gestion$tac
sim_TACglob@outputSp$N$COR
# courbe d'age

sim_TACglob@output$nbv_f
sim_TACglob@output$effort2_f
sim_TACglob@output$GVLav_f
sim_TACglob@output$gva_f
sim_TACglob@output$gp_f
sim_TACglob@output$wageg_f
sim_TACglob@output$wagen_f



sim_TACglob@outputSp$Fbar$COR
sim_TACglob@output$nbv_f
```



Cependant, les réductions aussi drastiques peuvent être limitées en ciblant les flottilles affectées. Par exemple, l'espèce ciblé est pêchées à `r IAM_input_1984@input$COR$Lref_f_m_e["Thalassa", "Filet_COR"] /sum(IAM_input_1984@input$COR$Lref_f_m_e, na.rm = TRUE) * 100` % par la flottille dite "Thalassa", via le métier "Filet_COR". Il serait donc plus intéressant de diminuer l'effort sur cette flottille uniquement.

Pour cela on peut agir sur la pondération des métiers et indiquer que l'on diminiue l'effort des métiers "Filet_COR" pour les flottilles qui l'utilisent au profit du méthier "Filet_DP". Il s'agit d'un **report d'effort** par métier.

```{r target_f}
trg_f <- c("Thalassa", "Haliotis")

mfm <- with(IAM_input_1984@input$Fleet,{
  (effort1_f_m * effort2_f_m * nbv_f_m) / as.vector(effort1_f * effort2_f * nbv_f)
})
mfm[!is.na(mfm)] <- 0 #report d'effort du m?tier 'Filet_COR' vers 'Filet_DP'
mfm[trg_f,"Filet_DP"] <- with(IAM_input_1984@input$Fleet, 
     Lref_f_m[trg_f,"Filet_DP"] / sum(Lref_f_m[trg_f,"Filet_DP"])
)
mfm[trg_f,"Filet_COR"] <- with(IAM_input_1984@input$Fleet, 
    - Lref_f_m[trg_f,"Filet_DP"] / sum(Lref_f_m[trg_f,"Filet_DP"])
)
mfm


IAM_argum_1984_Report <- IAM.editArgs_Gest(
  IAM_argum_1984, active = TRUE, control = "Nb vessels", target = "TAC",
  espece = "COR", delay = 4, type = "x", bounds = c(100, -100), 
  tac = c(NA, NA, rep(3200, 10)), mfm = mfm)
      #   84, 85, 1986:1995
```

```{r TACreport}
sim_TACreport <- IAM::IAM.model(objArgs = IAM_argum_1984_Report, objInput = IAM_input_1984)

sim_TACreport@outputSp$Fbar$COR
sim_TACreport@output$nbv_f
```

## Gestion TAC par flotille



<!-- ## References -->

<!-- <div id="refs"></div> -->

