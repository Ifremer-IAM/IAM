---
title: "Gestion avec TAC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Gestion avec TAC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
# bibliography: vignette.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r library, include = TRUE, eval=TRUE}
library(IAM)
```


Le modèle bio-économique IAM a été développé dans l'optique d'être utilisé pour des scénarios de gestion de quotats. Ainsi, des scénarios de Gestion par TAC peuvent être introduit à différentes échelles. Ce document traite de la gestion de TAC à un niveau interflotilles puis une autre partie détaillera la gestion intra flotilles.

L'ensemble de ces simulations sera réalisé avec le jeu de donnée example `Ifremer` composé de 7 flotilles et deux 3 espèces dynamiques dont une espèce à dynamique SS3.

```{r inport, eval=FALSE, results="hide"}
load("../dev/data/inpSS3darwiniana1984.RData")
input1984 <- IAM::IAM.input(
  fileIN = IAM_example("inputFile.xlsx"),t_init=1984,nbStep=12,folderFleet="../dev/data/fleets",
  Fq_i=list(DAR=iniFq_i),iniFq_i=list(DAR=iniFq_i),Fq_fmi=list(DAR=iniFq_fmi),iniFq_fmi=list(DAR=iniFq_fmi),
  FqLwt_i=list(DAR=iniFqLwt_i),iniFqLwt_i=list(DAR=iniFqLwt_i),FqLwt_fmi=list(DAR=iniFqLwt_fmi),iniFqLwt_fmi=list(DAR=iniFqLwt_fmi),
  FqDwt_i=list(DAR=iniFqDwt_i),iniFqDwt_i=list(DAR=iniFqDwt_i),FqDwt_fmi=list(DAR=iniFqDwt_fmi),iniFqDwt_fmi=list(DAR=iniFqDwt_fmi),
  Nt0s1q=list(DAR=Nt0s1q),Ni0q=list(DAR=Ni0q),iniNt0q=list(DAR=iniNt0q),matwt=list(DAR=mat_morphage)
)
summary(input1984)
```
```{r summaryexp, echo = FALSE}
#' summary method for iamInput class
setMethod(
  f = "summary", signature("iamInput"),
  function(object, ...) {
    spe <- object@specific
    cat(object@desc, "(IAM input) :\n")
    cat(sprintf(
      "Simulation of %d dynamic species, %d static species and %d fleet\n",
      length(spe$Species), length(spe$StaticSpp), length(spe$Fleet) 
    ))
    cat(rep("-",35), "\nDynamic Species | Model |     Ages\n", sep = "")
    cat(sprintf("%15s | %5s | %1s to %3s\n", spe$Species, 
                ifelse(spe$Q == 0, "XSA", "SS3"), 
                unlist(lapply(spe$Ages, head, 1)),
                unlist(lapply(spe$Ages, tail, 1)) ), sep = "")
    cat(rep("-",35),"\n", sep = "")
    cat("                  Fleet |  nbv\n", sprintf(
      "%22s | %4d\n", spe$Fleet, object@input$Fleet$nbv_f
    ))
    cat(sprintf("Simulation start in %d and end in %d (%d steps)\n",
                spe$t_init, tail(spe$times,1), spe$NbSteps ))
  }
)
```

```{r falseinport, echo = FALSE}
load("../dev/data/inputIFR.RData")
summary(input1984)
```

L'objet argument est laissé tel quel lors de l'utilisation de l'interface et sera édité à la main plus tard pour chaque scénario.

```{r argum, eval=FALSE}
argum1984 <- IAM.args(input1984)
```

```{r falseargum, echo = FALSE}
load("../dev/data/argumIFR.RData")
```

## Besoin d'un scénario *statu quo*

Afin de pouvoir comparer l'effet de chaque scénario, il nous faut un scénario de départ dans lequel aucune mesure de Gestion s'imposera.

Dans un premier temps il est utile de définir les dynamiques de recrutements ainsi que des éléments de paramétrage du module économique. On va pour cela éditer l'objet `argum1984`

```{r edit argum}
# Module SR
# TODO add boken stick Rec

# Module EcoDCF
argum1984@arguments$Eco$dr <- 0.04
argum1984@arguments$Eco$perscCalc <- as.integer(1)

# Module Gestion
argum1984@arguments$Gestion$active <- as.integer(0)
argum1984@arguments$Gestion$delay <- as.integer(1)
argum1984@arguments$Gestion$mfm[] <- with(input1984@input$Fleet,{
  (effort1_f_m * effort2_f_m * nbv_f_m) / as.vector(effort1_f * effort2_f * nbv_f)
})
argum1984@arguments$Gestion$mfm[is.na(argum1984@arguments$Gestion$mfm)] <- 0

# Module Scenario
argum1984@arguments$Scenario$active <- as.integer(0)
```


```{r statuquo, eval=FALSE}
sim_statu_quo <- IAM::IAM.model(objArgs = argum1984, objInput = input1984)
```


## Gestion TAC générale

Les différentes options de réglages du module Gestion sont exposées dans la vignette "Utilisation IAM dans R". Il s'agit ici de les explorer plus en avant et de les utiliser.

```{r editargum}

# argum1984_TAC <- IAM.args(argum1984)
setGestion_tac <- function(argum, species, delay = 1, bound = c(0,0), tac){

  argum@arguments$Gestion$active <- 1
  argum@arguments$Gestion$espece <- species
  argum@arguments$Gestion$delay <- delay
  argum@arguments$Gestion$sup <- bound[1]
  argum@arguments$Gestion$inf <- bound[2]
  argum@arguments$Gestion$tac <- tac

  return(argum)
}
argum1984_TAC <- setGestion_tac(argum1984, species = "COR", delay = 2, bound = c(100, -100), # X2 a -100 entraine des flottes a 0 navires !
                            c(NA, 3300, 3250, 3200, 3200, 3200, 3200, 3200, 3200, 3200, 3200, 3200))
#                             84, 1985, 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995
argum1984@arguments$Gestion$typeG <- 1

```



```{r TAC, eval = FALSE}
sim_TACglob <- IAM::IAM.model(objArgs = argum1984_TAC, objInput = input1984,
                              verbose = TRUE, force_t = 7)
```

## Gestion TAC par flotille



<!-- ## References -->

<!-- <div id="refs"></div> -->

